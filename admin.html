<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Projects - SB INFRA</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="admin-body">
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="logo.png" alt="SB INFRA"></a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="projects.html">Projects</a></li>
                <li><a href="index.html#contact" class="btn-primary">Contact</a></li>
            </ul>
            <div class="hamburger"><i class="fas fa-bars"></i></div>
        </div>
    </nav>

    <main class="admin-page">
        <div id="adminLogin" class="admin-login">
            <div id="wrongUrlWarning"
                style="display:none; background:#fff3cd; border:1px solid #ffc107; color:#856404; padding:0.75rem 1rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem;">
                <strong>Use the server URL.</strong> This page was opened from your files. For login to work, start the
                server (run.bat or <code>npm start</code>), then in the browser go to: <a
                    href="http://localhost:3002/admin.html"
                    style="color:#856404; font-weight:600;">http://localhost:3002/admin.html</a>
            </div>
            <h2>Website owner login</h2>
            <p style="color:var(--text-light); font-size:0.9rem; margin-bottom:1rem;">Enter your admin password to add
                or edit projects.</p>
            <p style="font-size:0.8rem; color:var(--text-light); margin-bottom:0.75rem;">Default password: <code
                    style="background:#eee; padding:2px 6px; border-radius:4px;">sbinfra2024</code></p>
            <input type="password" id="adminSecret" placeholder="Admin password" autocomplete="off">
            <button type="button" class="btn-primary" id="loginBtn">Log in</button>
            <p id="loginError" class="admin-error" style="display:none;"></p>
        </div>

        <div id="adminPanel" style="display:none;">
            <div class="admin-bar">
                <h1>Admin Dashboard</h1>
                <div>
                    <a href="index.html" target="_blank" class="btn-secondary" style="margin-right:0.5rem;">View
                        public site</a>
                    <button type="button" id="logoutBtn"
                        style="padding:0.5rem 1rem; background:#eee; border:none; border-radius:5px; cursor:pointer;">Log
                        out</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="admin-tabs" style="margin: 1rem 0; border-bottom: 2px solid #eee;">
                <button class="tab-btn active" data-tab="customers"
                    style="padding: 0.75rem 1.5rem; margin-right: 0.5rem; border: none; background: var(--primary-color); color: white; border-radius: 5px 5px 0 0; cursor: pointer; font-weight: 600;">Customers</button>
                <button class="tab-btn" data-tab="projects"
                    style="padding: 0.75rem 1.5rem; border: none; background: #f0f0f0; color: var(--secondary-color); border-radius: 5px 5px 0 0; cursor: pointer; font-weight: 600;">Projects</button>
            </div>

            <!-- Customers Section -->
            <div id="customersSection" class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">Customer Leads</h2>
                    <button type="button" class="btn-secondary" id="refreshLeadsBtn" style="padding: 0.5rem 1rem;">ðŸ”„
                        Refresh</button>
                </div>
                <div id="leadsTable" style="overflow-x: auto;"></div>
            </div>

            <!-- Projects Section -->
            <div id="projectsSection" class="admin-section" style="display:none;">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">Manage Projects</h2>
                    <button type="button" class="btn-primary" id="addProjectBtn">+ Add project</button>
                </div>

                <div id="projectFormWrap" class="admin-form-wrap" style="display:none;">
                    <h2 id="formTitle">Add project</h2>
                    <input type="hidden" id="formProjectId">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="formTitleInput" placeholder="e.g. Modern Villa, Whitefield" required>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="formDescription" placeholder="Brief description of the project"
                            required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Project Image</label>
                        <input type="file" id="formImageFile" accept="image/*">
                        <div id="imagePreview" style="margin-top:0.5rem; display:none;">
                            <img id="previewImg"
                                style="max-width:200px; max-height:200px; border-radius:8px; border:2px solid #ddd;">
                            <p style="font-size:0.85rem; color:var(--text-light); margin-top:0.25rem;">Selected image
                                preview</p>
                        </div>
                        <input type="hidden" id="formImageUrl">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="formLocation" placeholder="e.g. Bengaluru">
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <input type="text" id="formYear" placeholder="e.g. 2024">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="formCategory" placeholder="e.g. Villa, Residential">
                    </div>
                    <div class="admin-form-actions">
                        <button type="button" class="btn-primary" id="formSaveBtn">Save</button>
                        <button type="button" class="btn-secondary" id="formCancelBtn">Cancel</button>
                    </div>
                    <p id="formError" class="admin-error" style="display:none;"></p>
                </div>

                <div id="projectsList" class="admin-list"></div>
            </div>
            <!-- End Projects Section -->
        </div>
    </main>

    <script>
        const STORAGE_KEY = 'sbinfra_admin_secret';
        const API = (window.location.origin && window.location.protocol && window.location.protocol.startsWith('http'))
            ? window.location.origin
            : 'http://localhost:3002';

        const loginDiv = document.getElementById('adminLogin');
        const panelDiv = document.getElementById('adminPanel');
        const secretInput = document.getElementById('adminSecret');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const addProjectBtn = document.getElementById('addProjectBtn');
        const formWrap = document.getElementById('projectFormWrap');
        const formTitle = document.getElementById('formTitle');
        const formProjectId = document.getElementById('formProjectId');
        const formTitleInput = document.getElementById('formTitleInput');
        const formDescription = document.getElementById('formDescription');
        const formImageFile = document.getElementById('formImageFile');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const formImageUrl = document.getElementById('formImageUrl');
        const formLocation = document.getElementById('formLocation');
        const formYear = document.getElementById('formYear');
        const formCategory = document.getElementById('formCategory');
        const formSaveBtn = document.getElementById('formSaveBtn');
        const formCancelBtn = document.getElementById('formCancelBtn');
        const formError = document.getElementById('formError');
        const projectsList = document.getElementById('projectsList');
        const logoutBtn = document.getElementById('logoutBtn');
        const wrongUrlWarning = document.getElementById('wrongUrlWarning');
        const leadsTable = document.getElementById('leadsTable');
        const refreshLeadsBtn = document.getElementById('refreshLeadsBtn');
        const customersSection = document.getElementById('customersSection');
        const projectsSection = document.getElementById('projectsSection');
        const tabBtns = document.querySelectorAll('.tab-btn');

        if (!window.location.origin || !window.location.protocol.startsWith('http')) {
            if (wrongUrlWarning) wrongUrlWarning.style.display = 'block';
        }

        function getSecret() { return sessionStorage.getItem(STORAGE_KEY); }
        function setSecret(s) { sessionStorage.setItem(STORAGE_KEY, s); }
        function clearSecret() { sessionStorage.removeItem(STORAGE_KEY); }

        function headers() {
            const s = getSecret();
            return { 'Content-Type': 'application/json', ...(s ? { 'X-Admin-Secret': s } : {}) };
        }

        function showLogin(err) {
            panelDiv.style.display = 'none';
            loginDiv.style.display = 'block';
            loginError.style.display = err ? 'block' : 'none';
            if (err) loginError.textContent = err;
        }

        function showPanel() {
            loginDiv.style.display = 'none';
            panelDiv.style.display = 'block';
            loadLeads(); // Load leads by default
            loadProjects();
        }

        loginBtn.addEventListener('click', () => {
            const secret = secretInput.value.trim();
            if (!secret) {
                loginError.textContent = 'Enter the admin password.';
                loginError.style.display = 'block';
                return;
            }
            loginError.style.display = 'none';
            loginBtn.disabled = true;
            fetch(API + '/api/admin/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: secret })
            })
                .then(r => r.json().then(data => ({ ok: r.ok, data })))
                .then(({ ok, data }) => {
                    if (ok) {
                        setSecret(secret);
                        showPanel();
                        loginError.style.display = 'none';
                    } else {
                        clearSecret();
                        loginError.textContent = data.error || 'Invalid password.';
                        loginError.style.display = 'block';
                    }
                })
                .catch(() => {
                    clearSecret();
                    loginError.textContent = 'Could not reach server. 1) Start the server (run run.bat or npm start). 2) In the browser address bar, go to: http://localhost:3002/admin.html';
                    loginError.style.display = 'block';
                })
                .finally(() => { loginBtn.disabled = false; });
        });

        if (getSecret()) {
            fetch(API + '/api/admin/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: getSecret() }) })
                .then(r => { if (r.ok) showPanel(); else showLogin('Session expired. Log in again.'); })
                .catch(() => showLogin());
        }

        logoutBtn.addEventListener('click', () => { clearSecret(); showLogin(); secretInput.value = ''; });

        // Tab switching logic
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Update active tab button
                tabBtns.forEach(b => {
                    if (b === btn) {
                        b.style.background = 'var(--primary-color)';
                        b.style.color = 'white';
                        b.classList.add('active');
                    } else {
                        b.style.background = '#f0f0f0';
                        b.style.color = 'var(--secondary-color)';
                        b.classList.remove('active');
                    }
                });

                // Show/hide sections
                if (tab === 'customers') {
                    customersSection.style.display = 'block';
                    projectsSection.style.display = 'none';
                } else if (tab === 'projects') {
                    customersSection.style.display = 'none';
                    projectsSection.style.display = 'block';
                }
            });
        });

        // Load customer leads
        function loadLeads() {
            const secret = sessionStorage.getItem(STORAGE_KEY);
            if (!secret) return;

            fetch(API + '/api/leads', {
                headers: { 'X-Admin-Secret': secret }
            })
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.leads) {
                        leadsTable.innerHTML = '<p>No customer leads yet.</p>';
                        return;
                    }

                    if (data.leads.length === 0) {
                        leadsTable.innerHTML = '<p style="color: var(--text-light); padding: 2rem; text-align: center;">No customer inquiries yet. Leads will appear here when customers fill out the contact forms.</p>';
                        return;
                    }

                    // Sort leads by date (newest first)
                    const leads = data.leads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    leadsTable.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: var(--primary-color); color: white;">
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Name</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Mobile</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Location</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Source</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Message</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leads.map((lead, index) => `
                                    <tr style="border-bottom: 1px solid #f0f0f0; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
                                        <td style="padding: 1rem; font-weight: 500;">${escapeHtml(lead.name || 'N/A')}</td>
                                        <td style="padding: 1rem;">${escapeHtml(lead.mobile || 'N/A')}</td>
                                        <td style="padding: 1rem;">${escapeHtml(lead.location || 'N/A')}</td>
                                        <td style="padding: 1rem;"><span style="background: #e8f5e9; color: #2e7d32; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">${escapeHtml(lead.source || 'Website')}</span></td>
                                        <td style="padding: 1rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(lead.message || '')}">${escapeHtml(lead.message || '-')}</td>
                                        <td style="padding: 1rem; color: var(--text-light); font-size: 0.9rem;">${formatDate(lead.timestamp)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                })
                .catch(err => {
                    console.error('Error loading leads:', err);
                    leadsTable.innerHTML = '<p style="color: red;">Failed to load customer leads.</p>';
                });
        }

        // Format date helper
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('en-IN', options);
        }

        // Refresh leads button
        if (refreshLeadsBtn) {
            refreshLeadsBtn.addEventListener('click', loadLeads);
        }

        function loadProjects() {
            fetch(API + '/api/projects')
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.projects) { projectsList.innerHTML = '<p>No projects.</p>'; return; }
                    if (data.projects.length === 0) {
                        projectsList.innerHTML = '<p>No projects yet. Click "Add project" to create one.</p>';
                        return;
                    }
                    projectsList.innerHTML = data.projects.map(p => `
                        <div class="admin-project-row" data-id="${p.id}">
                            <div>
                                <h3>${escapeHtml(p.title)}</h3>
                                <span class="meta">${escapeHtml(p.location || '')} ${p.year ? ' Â· ' + p.year : ''}</span>
                            </div>
                            <div class="admin-project-actions">
                                <button type="button" class="edit-btn" data-id="${p.id}">Edit</button>
                                <button type="button" class="delete-btn delete" data-id="${p.id}">Delete</button>
                            </div>
                        </div>
                    `).join('');
                    projectsList.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', () => openEditForm(btn.dataset.id));
                    });
                    projectsList.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => deleteProject(btn.dataset.id));
                    });
                })
                .catch(() => { projectsList.innerHTML = '<p>Failed to load projects.</p>'; });
        }

        function openEditForm(id) {
            fetch(API + '/api/projects/' + id)
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.project) return;
                    const p = data.project;
                    formTitle.textContent = 'Edit project';
                    formProjectId.value = p.id;
                    formTitleInput.value = p.title || '';
                    formDescription.value = p.description || '';
                    formImageUrl.value = p.imageUrl || '';

                    // Show existing image if available
                    if (p.imageUrl) {
                        previewImg.src = p.imageUrl;
                        imagePreview.style.display = 'block';
                    } else {
                        imagePreview.style.display = 'none';
                    }

                    formLocation.value = p.location || '';
                    formYear.value = p.year || '';
                    formCategory.value = p.category || '';
                    formWrap.style.display = 'block';
                    formError.style.display = 'none';
                });
        }

        addProjectBtn.addEventListener('click', () => {
            formTitle.textContent = 'Add project';
            formProjectId.value = '';
            formTitleInput.value = '';
            formDescription.value = '';
            formImageFile.value = '';
            formImageUrl.value = '';
            imagePreview.style.display = 'none';
            formLocation.value = '';
            formYear.value = '';
            formCategory.value = '';
            formWrap.style.display = 'block';
            formError.style.display = 'none';
        });

        formCancelBtn.addEventListener('click', () => { formWrap.style.display = 'none'; });

        formImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    previewImg.src = ev.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        formSaveBtn.addEventListener('click', async () => {
            const id = formProjectId.value;
            const title = formTitleInput.value.trim();
            const description = formDescription.value.trim();

            if (!title || !description) {
                formError.textContent = 'Title and description are required.';
                formError.style.display = 'block';
                return;
            }

            formError.style.display = 'none';
            formSaveBtn.disabled = true;

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('location', formLocation.value.trim());
            formData.append('year', formYear.value.trim());
            formData.append('category', formCategory.value.trim() || 'Residential');

            if (formImageFile.files[0]) {
                formData.append('image', formImageFile.files[0]);
            } else if (formImageUrl.value) {
                formData.append('imageUrl', formImageUrl.value.trim());
            }

            if (id) formData.append('id', id);

            const url = id ? API + '/api/projects/' + id : API + '/api/projects';
            const method = id ? 'PUT' : 'POST';
            const secret = getSecret();

            fetch(url, {
                method,
                headers: secret ? { 'X-Admin-Secret': secret } : {},
                body: formData
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        formWrap.style.display = 'none';
                        loadProjects();
                    } else {
                        formError.textContent = data.error || 'Failed to save.';
                        formError.style.display = 'block';
                    }
                })
                .catch(() => {
                    formError.textContent = 'Network error. Try again.';
                    formError.style.display = 'block';
                })
                .finally(() => { formSaveBtn.disabled = false; });
        });

        function deleteProject(id) {
            if (!confirm('Delete this project?')) return;
            fetch(API + '/api/projects/' + id, { method: 'DELETE', headers: headers() })
                .then(r => r.json())
                .then(data => {
                    if (data.success) loadProjects();
                    else alert(data.error || 'Delete failed.');
                })
                .catch(() => alert('Network error.'));
        }

        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        document.querySelector('.hamburger')?.addEventListener('click', () => {
            const nav = document.querySelector('.nav-links');
            nav.style.display = nav.style.display === 'flex' ? 'none' : 'flex';
        });
    </script>
</body>

</html>